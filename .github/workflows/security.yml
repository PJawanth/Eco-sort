# ===========================================
# Security Scanning Pipeline - Production Grade
# ===========================================
# Comprehensive security scanning for dependencies, code, and secrets

name: Security Scan

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main]
  schedule:
    # Weekly security scan (Sunday at midnight)
    - cron: '0 0 * * 0'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write
  actions: read

concurrency:
  group: security-${{ github.ref }}
  cancel-in-progress: true

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ============================================
  # Dependency Vulnerability Scanning
  # ============================================
  dependency-scan:
    name: ðŸ“¦ Dependency Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety pip-audit cyclonedx-bom
          pip install -r app/requirements.txt
          
      - name: Safety vulnerability check
        run: |
          echo "### ðŸ›¡ï¸ Safety Scan Results" >> $GITHUB_STEP_SUMMARY
          safety check --full-report --output json > safety-report.json 2>&1 || true
          safety check --full-report 2>&1 | tee safety-output.txt || true
          
          if grep -q "No known security vulnerabilities" safety-output.txt; then
            echo "âœ… No vulnerabilities found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Review safety-report.json for details" >> $GITHUB_STEP_SUMMARY
          fi
          
      - name: pip-audit check
        run: |
          echo "### ðŸ“‹ pip-audit Results" >> $GITHUB_STEP_SUMMARY
          pip-audit --format=json --output=pip-audit-report.json 2>&1 || true
          pip-audit 2>&1 | tee pip-audit-output.txt || true
          
          VULN_COUNT=$(grep -c "VULN" pip-audit-output.txt || echo "0")
          echo "Found vulnerabilities: $VULN_COUNT" >> $GITHUB_STEP_SUMMARY
          
      - name: Generate SBOM
        run: |
          cyclonedx-py requirements app/requirements.txt -o sbom.json --format json || true
          echo "âœ… SBOM generated" >> $GITHUB_STEP_SUMMARY
          
      - name: Upload dependency reports
        uses: actions/upload-artifact@v4
        with:
          name: dependency-reports
          path: |
            safety-report.json
            pip-audit-report.json
            sbom.json
          retention-days: 30

  # ============================================
  # Static Application Security Testing (SAST)
  # ============================================
  sast-scan:
    name: ðŸ” SAST Scan
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install SAST tools
        run: |
          pip install bandit semgrep
          
      - name: Bandit security scan
        run: |
          echo "### ðŸ”’ Bandit SAST Results" >> $GITHUB_STEP_SUMMARY
          bandit -r app/ -f json -o bandit-report.json -ll || true
          bandit -r app/ -f txt -ll 2>&1 | tee bandit-output.txt || true
          
          HIGH_ISSUES=$(grep -c "High" bandit-output.txt || echo "0")
          MEDIUM_ISSUES=$(grep -c "Medium" bandit-output.txt || echo "0")
          
          echo "- High severity: $HIGH_ISSUES" >> $GITHUB_STEP_SUMMARY
          echo "- Medium severity: $MEDIUM_ISSUES" >> $GITHUB_STEP_SUMMARY
          
      - name: Semgrep scan
        run: |
          echo "### ðŸ”¬ Semgrep Results" >> $GITHUB_STEP_SUMMARY
          semgrep scan --config=auto --json --output=semgrep-report.json app/ 2>&1 || true
          semgrep scan --config=auto app/ 2>&1 | tee semgrep-output.txt || true
          
          FINDINGS=$(grep -c "Finding" semgrep-output.txt || echo "0")
          echo "Findings: $FINDINGS" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true
          
      - name: Upload SAST reports
        uses: actions/upload-artifact@v4
        with:
          name: sast-reports
          path: |
            bandit-report.json
            semgrep-report.json
          retention-days: 30

  # ============================================
  # CodeQL Analysis
  # ============================================
  codeql:
    name: ðŸ”¬ CodeQL Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      security-events: write
      actions: read
      contents: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python
          queries: security-and-quality
          
      - name: Autobuild
        uses: github/codeql-action/autobuild@v3
        
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:python"
          output: codeql-results.sarif
          upload: true

  # ============================================
  # Secret Scanning
  # ============================================
  secret-scan:
    name: ðŸ” Secret Scan
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Gitleaks scan
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}
        continue-on-error: true
          
      - name: Trufflehog scan
        uses: trufflesecurity/trufflehog@main
        with:
          extra_args: --only-verified
        continue-on-error: true
          
      - name: Custom secret patterns
        run: |
          echo "### ðŸ” Secret Pattern Scan" >> $GITHUB_STEP_SUMMARY
          
          # Check for common secret patterns
          PATTERNS=(
            "api[_-]?key"
            "secret[_-]?key"
            "password"
            "private[_-]?key"
            "access[_-]?token"
          )
          
          FOUND=0
          for pattern in "${PATTERNS[@]}"; do
            MATCHES=$(grep -riE "$pattern\s*[:=]\s*['\"][^'\"]{10,}['\"]" --include="*.py" --include="*.json" --include="*.yml" . 2>/dev/null | grep -v ".env.example" | grep -v "test" || true)
            if [ -n "$MATCHES" ]; then
              echo "âš ï¸ Potential secret found matching pattern: $pattern" >> $GITHUB_STEP_SUMMARY
              FOUND=1
            fi
          done
          
          if [ $FOUND -eq 0 ]; then
            echo "âœ… No secret patterns detected" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # Infrastructure Security (IaC)
  # ============================================
  iac-scan:
    name: ðŸ—ï¸ IaC Security
    runs-on: ubuntu-latest
    timeout-minutes: 15
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Checkov scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: infra/
          framework: bicep,arm
          output_format: sarif
          output_file_path: checkov-results.sarif
          soft_fail: true
          
      - name: Upload Checkov SARIF
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: checkov-results.sarif
        continue-on-error: true

  # ============================================
  # License Compliance
  # ============================================
  license-check:
    name: ðŸ“œ License Check
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Install license checker
        run: pip install pip-licenses
        
      - name: Check licenses
        run: |
          pip install -r app/requirements.txt
          echo "### ðŸ“œ License Summary" >> $GITHUB_STEP_SUMMARY
          pip-licenses --format=markdown >> $GITHUB_STEP_SUMMARY
          
          # Check for copyleft licenses
          echo "" >> $GITHUB_STEP_SUMMARY
          COPYLEFT=$(pip-licenses --format=csv | grep -iE "GPL|AGPL|LGPL" || echo "")
          if [ -n "$COPYLEFT" ]; then
            echo "âš ï¸ Copyleft licenses found - review required:" >> $GITHUB_STEP_SUMMARY
            echo "$COPYLEFT" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… No copyleft licenses detected" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # Security Summary
  # ============================================
  summary:
    name: ðŸ“‹ Security Summary
    runs-on: ubuntu-latest
    needs: [dependency-scan, sast-scan, codeql, secret-scan, iac-scan, license-check]
    if: always()
    
    steps:
      - name: Generate security summary
        run: |
          echo "## ðŸ”’ Security Scan Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Scan Type | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Dependencies | ${{ needs.dependency-scan.result == 'success' && 'âœ… Passed' || 'âš ï¸ Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” SAST | ${{ needs.sast-scan.result == 'success' && 'âœ… Passed' || 'âš ï¸ Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”¬ CodeQL | ${{ needs.codeql.result == 'success' && 'âœ… Passed' || 'âš ï¸ Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Secrets | ${{ needs.secret-scan.result == 'success' && 'âœ… Passed' || 'âš ï¸ Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ—ï¸ IaC | ${{ needs.iac-scan.result == 'success' && 'âœ… Passed' || 'âš ï¸ Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“œ Licenses | ${{ needs.license-check.result == 'success' && 'âœ… Passed' || 'âš ï¸ Review' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Generated: $(date -u +%Y-%m-%dT%H:%M:%SZ)_" >> $GITHUB_STEP_SUMMARY
